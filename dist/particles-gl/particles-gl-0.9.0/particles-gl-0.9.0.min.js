Kiwi.GameObjects.StatelessParticles=function(a,b,c,d,e,f){return Kiwi.Entity.call(this,a,c,d),this.constructor(a,b,c,d,e,f)},Kiwi.extend(Kiwi.GameObjects.StatelessParticles,Kiwi.Entity),Kiwi.GameObjects.StatelessParticles.prototype.constructor=function(a,b,c,d,e,f){return"undefined"==typeof c&&(c=0),"undefined"==typeof d&&(d=0),"undefined"==typeof f&&(f=!0),this.config=e||Kiwi.GameObjects.StatelessParticles.defaultConfig,this.game.renderOption===Kiwi.RENDERER_WEBGL&&(this.glRenderer=this.game.renderer.requestRendererInstance("StatelessParticleRenderer",{config:this.config})),"undefined"==typeof b?(console.error("A Texture Atlas was not passed when instantiating a new StatelessParticles."),this.willRender=!1,void(this.active=!1)):(this.atlas=b,this.cellIndex=this.atlas.cellIndex,this.width=b.cells[0].w,this.height=b.cells[0].h,this.transform.rotPointX=this.width/2,this.transform.rotPointY=this.height/2,this.box=this.components.add(new Kiwi.Components.Box(this,c,d,this.width,this.height)),void(f&&this.start()))},Kiwi.GameObjects.StatelessParticles.prototype.started=!1,Kiwi.GameObjects.StatelessParticles.prototype.start=function(){this._generateParticles(),this.started=!0},Kiwi.GameObjects.StatelessParticles.prototype.objType=function(){return"StatelessParticles"},Kiwi.GameObjects.StatelessParticles.prototype._generateParticles=function(){for(var a=this.config,b=[],c=0;c<a.numParts;c++){var d={x:0,y:0},e={x:0,y:0},f={x:a.velOffsetX,y:a.velOffsetY},g={x:0,y:0};switch(a.posShape){case"Radial":d=a.posConstrain?this.randomPointCirclePerimeter(a.posRadialStart,a.posRadialEnd):this.randomPointCircle(a.posRadialStart,a.posRadialEnd),e.x=d.x*a.posRadius,e.y=d.y*a.posRadius;break;case"Rect":d=a.posConstrain?this.randomPointRectPerimeter():this.randomPointRect(),e.x=d.x*a.posWidth,e.y=d.y*a.posHeight;break;case"Line":d=this.randomPointLine(a.posAngle),e.x=d.x*a.posLength,e.y=d.y*a.posLength;break;case"Constant":}switch(a.velShape){case"Center":var h=d,i=a.minVel+Math.random()*(a.maxVel-a.minVel);f.x=h.x*i,f.y=h.y*i;break;case"Radial":g=a.velConstrain?this.randomPointCirclePerimeter(a.velRadialStart,a.velRadialEnd):this.randomPointCircle(a.velRadialStart,a.velRadialEnd),f.x+=g.x*a.velRadius,f.y+=g.y*a.velRadius;break;case"Rect":g=a.velConstrain?this.randomPointRectPerimeter():this.randomPointRect(),f.x+=g.x*a.velWidth,f.y+=g.y*a.velHeight;break;case"Line":g=this.randomPointLine(a.velAngle),f.x+=g.x*a.velLength,f.y+=g.y*a.velLength;break;case"Constant":}var j,k=Math.max(a.velAngMax,a.velAngMin)-Math.min(a.velAngMax,a.velAngMin);j=a.velAngMin+Math.random()*k,e.x+=a.posOffsetX,e.y+=a.posOffsetY,b.push(e.x,e.y,f.x,f.y);var l=a.minStartTime+Math.random()*(a.maxStartTime-a.minStartTime),m=a.minLifespan+Math.random()*(a.maxLifespan-a.minLifespan),n=0;if(a.cells)var o=a.cells.length;o>1&&(n=Math.floor(Math.random()*o)),b.push(l,m,j);var p=this.atlas.cells[n];b.push(p.x,p.y,p.w,p.h)}this.glRenderer.initBatch(b)},Kiwi.GameObjects.StatelessParticles.prototype.render=function(){},Kiwi.GameObjects.StatelessParticles.prototype.renderGL=function(a){this.started&&this.glRenderer.draw(a,this.transform)},Kiwi.GameObjects.StatelessParticles.defaultConfig={numParts:20,posOffsetX:0,posOffsetY:0,posRadius:50,posRadialStart:4.363323129985823,posRadialEnd:5.061454830783556,posWidth:100,posHeight:100,posAngle:0,posLength:100,posConstrain:!0,posShape:"Radial",maxVel:100,minVel:70,velConstrain:!1,velShape:"Line",velOffsetX:0,velOffsetY:0,velAngMin:-2,velAngMax:2,velRadius:100,velRadialStart:0,velRadialEnd:6.283185307179586,velWidth:100,velHeight:100,velAngle:0,velLength:30,minStartTime:1,maxStartTime:6,minLifespan:3,maxLifespan:5,gravity:"0",startSize:"4",endSize:"150",loop:!0,colEnvKeyframes:["0.5","0.6"],alpha:"1",colEnv0:[1,0,0],colEnv1:[1,1,0],colEnv2:[1,1,1],colEnv3:[0,0,0],alphaGradient:[1,1,1,0],alphaStops:[.3,.7]},Kiwi.GameObjects.StatelessParticles.prototype.randomPointCirclePerimeter=function(a,b){var c=a+(b-a)*Math.random();return{x:Math.cos(c),y:Math.sin(c)}},Kiwi.GameObjects.StatelessParticles.prototype.randomPointCircle=function(a,b){var c=a+(b-a)*Math.random(),d=Math.random()+Math.random(),e=d>1?2-d:d;return{x:e*Math.cos(c),y:e*Math.sin(c)}},Kiwi.GameObjects.StatelessParticles.prototype.randomPointRect=function(){return{x:Math.random()-.5,y:Math.random()-.5}},Kiwi.GameObjects.StatelessParticles.prototype.randomPointRectPerimeter=function(){var a=4*Math.random();return 1>a?{x:a-.5,y:-.5}:2>a?{x:.5,y:a-1.5}:3>a?{x:a-2.5,y:.5}:{x:-.5,y:a-3.5}},Kiwi.GameObjects.StatelessParticles.prototype.randomPointLine=function(a){var b=Math.random()-.5,c=b*Math.cos(a),d=b*Math.sin(a);return{x:c,y:d}},Kiwi.Plugins.ParticlesGL={name:"ParticlesGL",version:"0.9.0"},Kiwi.PluginManager.register(Kiwi.Plugins.ParticlesGL),Kiwi.Renderers.StatelessParticleRenderer=function(a,b,c){Kiwi.Renderers.Renderer.call(this,a,b,!1,c),this._maxItems=2e3,this.gl=a,this._config=c.config,this._config||console.log("no particle configuration supplied"),this.vertexBuffer=new Kiwi.Renderers.GLArrayBuffer(a,11),this.startTime=Date.now()},Kiwi.extend(Kiwi.Renderers.StatelessParticleRenderer,Kiwi.Renderers.Renderer),Kiwi.Renderers.StatelessParticleRenderer.prototype.RENDERER_ID="StatelessParticleRenderer",Kiwi.Renderers.StatelessParticleRenderer.prototype.enable=function(a,b){this.shaderPair=this.shaderManager.requestShader(a,"StatelessParticleShader");var c=this._config;a.uniform1i(this.shaderPair.uniforms.uSampler.location,0),a.uniform2fv(this.shaderPair.uniforms.uResolution.location,b.stageResolution),a.uniform2fv(this.shaderPair.uniforms.uTextureSize.location,new Float32Array([b.textureAtlas.width,b.textureAtlas.height])),a.uniformMatrix3fv(this.shaderPair.uniforms.uCamMatrix.location,!1,b.camMatrix),this.camMatrix=new Float32Array(b.camMatrix.buffer),a.uniform1f(this.shaderPair.uniforms.uT.location,0),a.uniform1f(this.shaderPair.uniforms.uGravity.location,c.gravity),a.uniform2fv(this.shaderPair.uniforms.uPointSizeRange.location,new Float32Array([c.startSize,c.endSize])),a.uniform3fv(this.shaderPair.uniforms.uColEnv0.location,new Float32Array(c.colEnv0)),a.uniform3fv(this.shaderPair.uniforms.uColEnv1.location,new Float32Array(c.colEnv1)),a.uniform3fv(this.shaderPair.uniforms.uColEnv2.location,new Float32Array(c.colEnv2)),a.uniform3fv(this.shaderPair.uniforms.uColEnv3.location,new Float32Array(c.colEnv3)),a.uniform2fv(this.shaderPair.uniforms.uColEnvKeyframes.location,new Float32Array(c.colEnvKeyframes)),a.uniform1f(this.shaderPair.uniforms.uAlpha.location,c.alpha),a.uniform4fv(this.shaderPair.uniforms.uAlphaGradient.location,new Float32Array(c.alphaGradient)),a.uniform2fv(this.shaderPair.uniforms.uAlphaStops.location,new Float32Array(c.alphaStops)),a.uniform1f(this.shaderPair.uniforms.uLoop.location,c.loop?1:0)},Kiwi.Renderers.StatelessParticleRenderer.prototype.disable=function(a){a.disableVertexAttribArray(this.shaderPair.attributes.aXYVxVy),a.disableVertexAttribArray(this.shaderPair.attributes.aBirthLifespanAngle),a.disableVertexAttribArray(this.shaderPair.attributes.aCellXYWH)},Kiwi.Renderers.StatelessParticleRenderer.prototype.clear=function(){this.vertexBuffer.clear()},Kiwi.Renderers.StatelessParticleRenderer.prototype.draw=function(a,b){var c=b.getConcatenatedMatrix(),d=new Float32Array([c.a,c.b,0,c.c,c.d,0,c.tx,c.ty,1]),e=mat3.create();mat3.mul(e,this.camMatrix,d),a.uniformMatrix3fv(this.shaderPair.uniforms.uCamMatrix.location,!1,e);var f=Date.now()-this.startTime;a.uniform1f(this.shaderPair.uniforms.uT.location,f/1e3),a.blendEquationSeparate(a.FUNC_ADD,a.FUNC_ADD),a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE),a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer.buffer),a.enableVertexAttribArray(this.shaderPair.attributes.aXYVxVy),a.vertexAttribPointer(this.shaderPair.attributes.aXYVxVy,4,a.FLOAT,!1,44,0),a.enableVertexAttribArray(this.shaderPair.attributes.aBirthLifespanAngle),a.vertexAttribPointer(this.shaderPair.attributes.aBirthLifespanAngle,3,a.FLOAT,!1,44,16),a.enableVertexAttribArray(this.shaderPair.attributes.aCellXYWH),a.vertexAttribPointer(this.shaderPair.attributes.aCellXYWH,4,a.FLOAT,!1,44,28),a.drawArrays(a.POINTS,0,this._config.numParts),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA)},Kiwi.Renderers.StatelessParticleRenderer.prototype.updateStageResolution=function(a,b){a.uniform2fv(this.shaderPair.uniforms.uResolution.location,b)},Kiwi.Renderers.StatelessParticleRenderer.prototype.updateTextureSize=function(a,b){a.uniform2fv(this.shaderPair.uniforms.uTextureSize.location,b)},Kiwi.Renderers.StatelessParticleRenderer.prototype.initBatch=function(a){this.vertexBuffer.items=a,this.vertexBuffer.uploadBuffer(this.gl,this.vertexBuffer.items)},Kiwi.Shaders.StatelessParticleShader=function(){Kiwi.Shaders.ShaderPair.call(this)},Kiwi.extend(Kiwi.Shaders.StatelessParticleShader,Kiwi.Shaders.ShaderPair),Kiwi.Shaders.StatelessParticleShader.prototype.init=function(a){Kiwi.Shaders.ShaderPair.prototype.init.call(this,a),this.attributes.aXYVxVy=a.getAttribLocation(this.shaderProgram,"aXYVxVy"),this.attributes.aBirthLifespanAngle=a.getAttribLocation(this.shaderProgram,"aBirthLifespanAngle"),this.attributes.aCellXYWH=a.getAttribLocation(this.shaderProgram,"aCellXYWH"),this.initUniforms(a)},Kiwi.Shaders.StatelessParticleShader.prototype.attributes={aXYVxVy:null,aBirthLifespan:null,aCellXYWH:null},Kiwi.Shaders.StatelessParticleShader.prototype.uniforms={uCamMatrix:{type:"mat3"},uTextureSize:{type:"2fv"},uResolution:{type:"2fv"},uTextureSize:{type:"2fv"},uSampler:{type:"1i"},uT:{type:"1f"},uGravity:{type:"1f"},uPointSizeRange:{type:"2fv"},uColEnv0:{type:"3fv"},uColEnv1:{type:"3fv"},uColEnv2:{type:"3fv"},uColEnv3:{type:"3fv"},uColEnvKeyframes:{type:"2fv"},uAlpha:{type:"1f"},uAlphaGradient:{type:"4fv"},uAlphaStops:{type:"2fv"},uLoop:{type:"1f"}},Kiwi.Shaders.StatelessParticleShader.prototype.fragSource=["precision mediump float;","uniform sampler2D uSampler;","varying vec4 vCol;","varying mat4 vRotationMatrix;","varying vec4 vCell;","void main(void) {","vec2 cellCoord = vCell.xy + vCell.zw * gl_PointCoord;","vec2 texCoord = (vRotationMatrix * vec4(cellCoord, 0, 1)).xy;","vec4 sampleCol = texture2D(uSampler, texCoord);","gl_FragColor.rgb = vCol.rgb * sampleCol.rgb;","gl_FragColor.a = sampleCol.a * vCol.a;","}"],Kiwi.Shaders.StatelessParticleShader.prototype.vertSource=["precision mediump float;","attribute vec4 aXYVxVy;","attribute vec3 aBirthLifespanAngle;","attribute vec4 aCellXYWH;","uniform mat3 uCamMatrix;","uniform vec2 uTextureSize;","uniform vec2 uResolution;","uniform float uT;","uniform float uGravity;","uniform vec2 uPointSizeRange;","uniform vec3 uColEnv0;","uniform vec3 uColEnv1;","uniform vec3 uColEnv2;","uniform vec3 uColEnv3;","uniform vec2 uColEnvKeyframes;","uniform vec4 uAlphaGradient;","uniform vec2 uAlphaStops;","uniform float uAlpha;","uniform bool uLoop;","varying vec4 vCol;","varying mat4 vRotationMatrix;","varying vec4 vCell;","void main(void) {","float lerp;","float birthTime = aBirthLifespanAngle.x;","float lifespan = aBirthLifespanAngle.y;","float angularVelocity = aBirthLifespanAngle.z;","float deathTime = birthTime+lifespan;","float age = uT - birthTime;","age = mod(uT-birthTime,lifespan);","lerp =  age / lifespan;","gl_PointSize = mix(uPointSizeRange.x,uPointSizeRange.y,lerp);","if (uT < birthTime || (uT >= deathTime && !uLoop )) {","gl_Position = vec4(9999.0,0,0,0);","} else {","vec2 pos = aXYVxVy.xy; ","vec2 vel = aXYVxVy.zw;","pos += age * vel;","pos.y += 0.5 * uGravity * age * age;","pos = (uCamMatrix * vec3(pos,1.0)).xy;","pos = (pos / uResolution) * 2.0 - 1.0;","gl_Position = vec4(pos * vec2(1, -1), 0, 1);","float colLerp = 1.0;","if (lerp <= uColEnvKeyframes.x) {","float cLerp = lerp / uColEnvKeyframes.x; ","vCol = vec4(mix(uColEnv0,uColEnv1,cLerp),1.0);","} else if (lerp > uColEnvKeyframes.x && lerp <= uColEnvKeyframes.y) {","float cLerp = (lerp - uColEnvKeyframes.x) / (uColEnvKeyframes.y - uColEnvKeyframes.x); ","vCol = vec4(mix(uColEnv1,uColEnv2,cLerp),1.0);","} else {","float cLerp = (lerp - uColEnvKeyframes.y) / (1.0 - uColEnvKeyframes.y); ","vCol = vec4(mix(uColEnv2,uColEnv3,cLerp),1.0);","}","if (lerp <= uAlphaStops.x) {","vCol.a = mix(uAlphaGradient.x,uAlphaGradient.y,lerp/uAlphaStops.x);","} else if (lerp >uAlphaStops.x && lerp <= uAlphaStops.y) {","vCol.a = mix(uAlphaGradient.y,uAlphaGradient.z,(lerp - uAlphaStops.x) / (uAlphaStops.y - uAlphaStops.x));","} else {","vCol.a = mix(uAlphaGradient.z,uAlphaGradient.w,(lerp - uAlphaStops.y) / (1.0 - uAlphaStops.y));","}","vCol.a *= uAlpha;","float ang = age * angularVelocity;","vec2 ratio = vec2(1.0 / uTextureSize.x,1.0 / uTextureSize.y);","vec4 normCell = aCellXYWH;","normCell.xz *= ratio;","normCell.yw *= ratio;","vec2 cellCenter = vec2(normCell.x + normCell.z / 2.0,normCell.y + normCell.w / 2.0);","float c = cos(ang);","float s = sin(ang);","mat4 transInMat = mat4(1.0, 0.0, 0.0, 0.0,","0.0, 1.0, 0.0, 0.0,","0.0, 0.0, 1.0, 0.0,","cellCenter.x,cellCenter.y, 0.0, 1.0);","mat4 rotMat = mat4(c, -s, 0.0, 0.0,","s, c, 0.0, 0.0,","0.0, 0.0, 1.0, 0.0,","0.0, 0.0, 0.0, 1.0);","mat4 resultMat = transInMat * rotMat;","resultMat[3][0] = resultMat[3][0] + resultMat[0][0] * -cellCenter.x + resultMat[1][0] * -cellCenter.y;","resultMat[3][1] = resultMat[3][1] + resultMat[0][1] * -cellCenter.x + resultMat[1][1] * -cellCenter.y;","resultMat[3][2] = resultMat[3][2] + resultMat[0][2] * -cellCenter.x + resultMat[1][2] * -cellCenter.y;","vRotationMatrix = resultMat;","vCell = normCell;","} ","}"];