Kiwi.GameObjects.StatelessParticles=function(a,b,c,d,e){return Kiwi.Entity.call(this,a,c,d),this.constructor(a,b,c,d,e)},Kiwi.extend(Kiwi.GameObjects.StatelessParticles,Kiwi.Entity),function(){var a={constructor:function(a,b,c,d,e){return"undefined"==typeof c&&(c=0),"undefined"==typeof d&&(d=0),"undefined"==typeof e&&(e=this.defaultConfig),this.config=e,this.randoms=function(){for(var a=[],b=0;5e3>b;b++)a.push(Math.random());return a}(),this.game.renderOption===Kiwi.RENDERER_WEBGL&&(this.glRenderer=this.game.renderer.requestRendererInstance("StatelessParticleRenderer",{config:this.config})),"undefined"==typeof b?(console.error("A Texture Atlas was not passed when instantiating a new StatelessParticles."),this.willRender=!1,void(this.active=!1)):(this.atlas=b,this.cellIndex=this.atlas.cellIndex,this.width=b.cells[0].w,this.height=b.cells[0].h,this.transform.rotPointX=this.width/2,this.transform.rotPointY=this.height/2,void(this.box=this.components.add(new Kiwi.Components.Box(this,c,d,this.width,this.height))))},defaultConfig:{numParts:20,posOffsetX:0,posOffsetY:0,posRadius:50,posRadialStart:4.363323129985823,posRadialEnd:5.061454830783556,posWidth:100,posHeight:100,posAngle:0,posLength:100,posConstrainRect:!0,posConstrainRadial:!0,posShape:"radial",maxVel:100,minVel:70,velConstrainRect:!1,velConstrainRadial:!1,velShape:"line",velOffsetX:0,velOffsetY:0,velAngMin:-2,velAngMax:2,velRadius:100,velRadialStart:0,velRadialEnd:6.283185307179586,velWidth:100,velHeight:100,velAngle:0,velLength:30,minStartTime:1,maxStartTime:6,minLifespan:3,maxLifespan:5,gravityX:-20,gravityY:30,startSize:4,endSize:150,loop:!0,colEnvKeyframes:[.5,.6],alpha:"1",colEnv0:[1,0,0],colEnv1:[1,1,0],colEnv2:[1,1,1],colEnv3:[0,0,0],alphaGradient:[1,1,1,0],alphaStops:[.3,.7]},effectState:"stopped",objType:function(){return"StatelessParticles"},drawingVectors:[],useDrawingVectors:!1,rnd:null,randoms:[],useRandoms:!1,numRandoms:5e3,nextRandomIndex:-1,timeoutLength:0,nextRandom:function(){return this.nextRandomIndex++,this.nextRandomIndex>=this.numRandoms&&(this.nextRandomIndex=-1),this.randoms[this.nextRandomIndex]},startEmitting:function(a,b,c){console.log("startEmitting"),"undefined"==typeof a&&(a=!0),"undefined"==typeof b&&(b=!1),"undefined"==typeof c&&(c=this.config.numParts),this.config.numParts=c,this.config.loop=a,this.glRenderer.resetTime(),this.glRenderer.resetPauseTime(),this.setConfig(this.config,!0,!0),!a&&b&&this.scheduleRemoval(1e3*this.timeoutLength),this.effectState="started",clearTimeout(this._timer),console.log("started")},stopEmitting:function(a,b){console.log("stopEmitting"),"undefined"==typeof a&&(a=!1),"undefined"==typeof b&&(b=!1),"started"===this.effectState&&(a&&b?this.remove():a&&!b?(this.effectState="stopped",console.log("stopped")):a||b?!a&&b&&(this.config.loop=!1,this.scheduleStop(1e3*this.timeoutLength,!0)):(this.glRenderer.pause(),this.effectState="stopping",console.log("stopping"),this.scheduleStop(1e3*this.timeoutLength,!1)))},scheduleStop:function(a,b){var c=this;clearTimeout(this._timer),this._timer=setTimeout(function(){c.effectState="stopped",console.log("stopped"),b&&c.remove.call(c)},a)},_timer:null,remove:function(){this.glRenderer.destroy(),this.exists=!1},setConfig:function(a,b,c){this.config=a,this.glRenderer.setConfig(a),b&&this._generateParticles(),c&&this.glRenderer._setConfigUniforms()},_generateParticles:function(){this.rnd=this.useRandoms?this.nextRandom:Math.random,this.nextRandomIndex=-1;var a=[],b=this.config;this.drawingVectors=[];for(var c=0;c<b.numParts;c++){var d={x:0,y:0},e={x:0,y:0},f={x:b.velOffsetX,y:b.velOffsetY},g={x:0,y:0};switch(b.posShape){case"radial":d=b.posRandomRadial?b.posConstrainRadial?this.randomPointCirclePerimeter(b.posRadialStart,b.posRadialEnd):this.randomPointCircle(b.posRadialStart,b.posRadialEnd):b.posConstrainRadial?this.regularPointCirclePerimeter(b.posRadialStart,b.posRadialEnd,c,b.numParts-1):this.randomPointCircle(b.posRadialStart,b.posRadialEnd),e.x=d.x*b.posRadius,e.y=d.y*b.posRadius;break;case"rectangle":d=b.posConstrainRect?this.randomPointRectPerimeter():this.randomPointRect(),e.x+=d.x*b.posWidth,e.y+=d.y*b.posHeight;break;case"line":d=b.posRandomLine?this.randomPointLine(b.posAngle):this.regularPointLine(b.posAngle,c,b.numParts-1),e.x+=d.x*b.posLength,e.y+=d.y*b.posLength;break;case"point":}switch(b.velShape){case"center":var h=d,i=b.minVel+this.rnd()*(b.maxVel-b.minVel);f.x=h.x*i,f.y=h.y*i;break;case"radial":g=b.velRandomRadial?b.velConstrainRadial?this.randomPointCirclePerimeter(b.velRadialStart,b.velRadialEnd):this.randomPointCircle(b.velRadialStart,b.velRadialEnd):b.velConstrainRadial?this.regularPointCirclePerimeter(b.velRadialStart,b.velRadialEnd,c,b.numParts-1):this.randomPointCircle(b.velRadialStart,b.velRadialEnd),f.x+=g.x*b.velRadius,f.y+=g.y*b.velRadius;break;case"rectangle":g=b.velConstrainRect?this.randomPointRectPerimeter():this.randomPointRect(),f.x+=g.x*b.velWidth,f.y+=g.y*b.velHeight;break;case"line":g=b.velRandomLine?this.randomPointLine(b.velAngle):this.regularPointLine(b.velAngle,c,b.numParts-1),f.x+=g.x*b.velLength,f.y+=g.y*b.velLength;break;case"point":}var j,k=Math.max(b.velAngMax,b.velAngMin)-Math.min(b.velAngMax,b.velAngMin);j=b.velAngMin+this.rnd()*k,e.x+=b.posOffsetX,e.y+=b.posOffsetY,a.push(e.x,e.y,f.x,f.y),this.drawingVectors.push({x:e.x,y:e.y,vx:f.x,vy:f.y});var l,m;l=b.minStartTime+this.rnd()*(b.maxStartTime-b.minStartTime),m=b.minLifespan+this.rnd()*(b.maxLifespan-b.minLifespan),this.timeoutLength=Math.max(this.timeoutLength,l+m);var n=0;if(b.cells){var o=b.cells.length;n=o>1?b.cells[Math.floor(this.rnd()*o)]:b.cells[0]}a.push(l,m,j);var p=this.atlas.cells[n];a.push(p.x,p.y,p.w,p.h)}this.glRenderer.initBatch(a)},renderGL:function(a){"stopped"!==this.effectState&&this.glRenderer.draw(a,this.transform)},regularPointCirclePerimeter:function(a,b,c,d){var e=(b-a)/d*c+a;return{x:Math.cos(e),y:Math.sin(e)}},randomPointCirclePerimeter:function(a,b){var c=a+(b-a)*this.rnd();return{x:Math.cos(c),y:Math.sin(c)}},randomPointCircle:function(a,b){var c=a+(b-a)*this.rnd(),d=this.rnd()+this.rnd(),e=d>1?2-d:d;return{x:e*Math.cos(c),y:e*Math.sin(c)}},randomPointRect:function(){return{x:this.rnd()-.5,y:this.rnd()-.5}},randomPointRectPerimeter:function(){var a=4*this.rnd();return 1>a?{x:a-.5,y:-.5}:2>a?{x:.5,y:a-1.5}:3>a?{x:a-2.5,y:.5}:{x:-.5,y:a-3.5}},regularPointLine:function(a,b,c){var d=1/c*b-.5,e=d*Math.cos(a),f=d*Math.sin(a);return{x:e,y:f}},randomPointLine:function(a){var b=this.rnd()-.5,c=b*Math.cos(a),d=b*Math.sin(a);return{x:c,y:d}}};for(var b in a)Kiwi.GameObjects.StatelessParticles.prototype[b]=a[b]}(),Kiwi.Plugins.ParticlesGL={name:"ParticlesGL",version:"0.9.0"},Kiwi.PluginManager.register(Kiwi.Plugins.ParticlesGL),Kiwi.Renderers.StatelessParticleRenderer=function(a,b,c){Kiwi.Renderers.Renderer.call(this,a,b,!1,c),this._maxItems=2e3,this.gl=a,this._config=c.config,this._config||console.log("no particle configuration supplied"),this.vertexBuffer=new Kiwi.Renderers.GLArrayBuffer(a,11),this.shaderPair=this.shaderManager.requestShader(a,"StatelessParticleShader"),this.resetTime()},Kiwi.extend(Kiwi.Renderers.StatelessParticleRenderer,Kiwi.Renderers.Renderer),Kiwi.Renderers.StatelessParticleRenderer.prototype.RENDERER_ID="StatelessParticleRenderer",Kiwi.Renderers.StatelessParticleRenderer.prototype.setConfig=function(a){this._config=a,this._setConfigUniforms(this.gl)},Kiwi.Renderers.StatelessParticleRenderer.prototype.resetTime=function(){this.startTime=Date.now()},Kiwi.Renderers.StatelessParticleRenderer.prototype.resetPauseTime=function(){this.pauseTime=999999999},Kiwi.Renderers.StatelessParticleRenderer.prototype.enable=function(a,b){this.shaderPair=this.shaderManager.requestShader(a,"StatelessParticleShader");this._config;this._setStandardUniforms(a,b.stageResolution,b.textureAtlas,b.camMatrix),this._setConfigUniforms(a)},Kiwi.Renderers.StatelessParticleRenderer.prototype._setStandardUniforms=function(a,b,c,d){a.uniform1i(this.shaderPair.uniforms.uSampler.location,0),a.uniform2fv(this.shaderPair.uniforms.uResolution.location,b),a.uniform2fv(this.shaderPair.uniforms.uTextureSize.location,new Float32Array([c.image.width,c.image.height])),a.uniformMatrix3fv(this.shaderPair.uniforms.uCamMatrix.location,!1,d),this.camMatrix=new Float32Array(d.buffer)},Kiwi.Renderers.StatelessParticleRenderer.prototype._setConfigUniforms=function(a){var b=this._config;a=a||this.gl,a.uniform1f(this.shaderPair.uniforms.uT.location,0),a.uniform1f(this.shaderPair.uniforms.uPauseTime.location,this.pauseTime),a.uniform2fv(this.shaderPair.uniforms.uGravity.location,new Float32Array([b.gravityX,b.gravityY])),a.uniform2fv(this.shaderPair.uniforms.uPointSizeRange.location,new Float32Array([b.startSize,b.endSize])),a.uniform3fv(this.shaderPair.uniforms.uColEnv0.location,new Float32Array(b.colEnv0)),a.uniform3fv(this.shaderPair.uniforms.uColEnv1.location,new Float32Array(b.colEnv1)),a.uniform3fv(this.shaderPair.uniforms.uColEnv2.location,new Float32Array(b.colEnv2)),a.uniform3fv(this.shaderPair.uniforms.uColEnv3.location,new Float32Array(b.colEnv3)),a.uniform2fv(this.shaderPair.uniforms.uColEnvKeyframes.location,new Float32Array(b.colEnvKeyframes)),a.uniform1f(this.shaderPair.uniforms.uAlpha.location,b.alpha),a.uniform4fv(this.shaderPair.uniforms.uAlphaGradient.location,new Float32Array(b.alphaGradient)),a.uniform2fv(this.shaderPair.uniforms.uAlphaStops.location,new Float32Array(b.alphaStops)),a.uniform1i(this.shaderPair.uniforms.uLoop.location,b.loop?1:0)},Kiwi.Renderers.StatelessParticleRenderer.prototype.disable=function(a){a.disableVertexAttribArray(this.shaderPair.attributes.aXYVxVy),a.disableVertexAttribArray(this.shaderPair.attributes.aBirthLifespanAngle),a.disableVertexAttribArray(this.shaderPair.attributes.aCellXYWH)},Kiwi.Renderers.StatelessParticleRenderer.prototype.clear=function(){this.vertexBuffer.clear()},Kiwi.Renderers.StatelessParticleRenderer.prototype.time=0,Kiwi.Renderers.StatelessParticleRenderer.prototype.pauseTime=999999999,Kiwi.Renderers.StatelessParticleRenderer.prototype.pause=function(a){a=a||this.gl,this.pauseTime=this.time/1e3,a.uniform1f(this.shaderPair.uniforms.uPauseTime.location,this.pauseTime)},Kiwi.Renderers.StatelessParticleRenderer.prototype.draw=function(a,b){var c=b.getConcatenatedMatrix(),d=new Float32Array([c.a,c.b,0,c.c,c.d,0,c.tx,c.ty,1]),e=mat3.create();mat3.mul(e,this.camMatrix,d),a.uniformMatrix3fv(this.shaderPair.uniforms.uCamMatrix.location,!1,e),this.time=Date.now()-this.startTime,a.uniform1f(this.shaderPair.uniforms.uT.location,this.time/1e3),a.blendEquationSeparate(a.FUNC_ADD,a.FUNC_ADD),a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE),a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer.buffer),a.enableVertexAttribArray(this.shaderPair.attributes.aXYVxVy),a.vertexAttribPointer(this.shaderPair.attributes.aXYVxVy,4,a.FLOAT,!1,44,0),a.enableVertexAttribArray(this.shaderPair.attributes.aBirthLifespanAngle),a.vertexAttribPointer(this.shaderPair.attributes.aBirthLifespanAngle,3,a.FLOAT,!1,44,16),a.enableVertexAttribArray(this.shaderPair.attributes.aCellXYWH),a.vertexAttribPointer(this.shaderPair.attributes.aCellXYWH,4,a.FLOAT,!1,44,28),a.drawArrays(a.POINTS,0,this._config.numParts),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA)},Kiwi.Renderers.StatelessParticleRenderer.prototype.updateStageResolution=function(a,b){a.uniform2fv(this.shaderPair.uniforms.uResolution.location,b)},Kiwi.Renderers.StatelessParticleRenderer.prototype.updateTextureSize=function(a,b){a.uniform2fv(this.shaderPair.uniforms.uTextureSize.location,b)},Kiwi.Renderers.StatelessParticleRenderer.prototype.initBatch=function(a){this.vertexBuffer.items=a,this.vertexBuffer.uploadBuffer(this.gl,this.vertexBuffer.items)},Kiwi.Renderers.StatelessParticleRenderer.prototype.destroy=function(a){a=a||this.gl,a.deleteBuffer(this.vertexBuffer.buffer)},Kiwi.Shaders.StatelessParticleShader=function(){Kiwi.Shaders.ShaderPair.call(this)},Kiwi.extend(Kiwi.Shaders.StatelessParticleShader,Kiwi.Shaders.ShaderPair),Kiwi.Shaders.StatelessParticleShader.prototype.init=function(a){Kiwi.Shaders.ShaderPair.prototype.init.call(this,a),this.attributes.aXYVxVy=a.getAttribLocation(this.shaderProgram,"aXYVxVy"),this.attributes.aBirthLifespanAngle=a.getAttribLocation(this.shaderProgram,"aBirthLifespanAngle"),this.attributes.aCellXYWH=a.getAttribLocation(this.shaderProgram,"aCellXYWH"),this.initUniforms(a)},Kiwi.Shaders.StatelessParticleShader.prototype.attributes={aXYVxVy:null,aBirthLifespan:null,aCellXYWH:null},Kiwi.Shaders.StatelessParticleShader.prototype.uniforms={uCamMatrix:{type:"mat3"},uTextureSize:{type:"2fv"},uResolution:{type:"2fv"},uTextureSize:{type:"2fv"},uSampler:{type:"1i"},uT:{type:"1f"},uPauseTime:{type:"1f"},uGravity:{type:"2fv"},uPointSizeRange:{type:"2fv"},uColEnv0:{type:"3fv"},uColEnv1:{type:"3fv"},uColEnv2:{type:"3fv"},uColEnv3:{type:"3fv"},uColEnvKeyframes:{type:"2fv"},uAlpha:{type:"1f"},uAlphaGradient:{type:"4fv"},uAlphaStops:{type:"2fv"},uLoop:{type:"1i"}},Kiwi.Shaders.StatelessParticleShader.prototype.fragSource=["precision mediump float;","uniform sampler2D uSampler;","varying vec4 vCol;","varying mat4 vRotationMatrix;","varying vec4 vCell;","void main(void) {","vec2 cellCoord = vCell.xy + vCell.zw * gl_PointCoord;","vec2 texCoord = (vRotationMatrix * vec4(cellCoord, 0, 1)).xy;","vec4 sampleCol = texture2D(uSampler, texCoord);","gl_FragColor.rgb = vCol.rgb * sampleCol.rgb;","gl_FragColor.a = sampleCol.a * vCol.a;","}"],Kiwi.Shaders.StatelessParticleShader.prototype.vertSource=["precision mediump float;","attribute vec4 aXYVxVy;","attribute vec3 aBirthLifespanAngle;","attribute vec4 aCellXYWH;","uniform mat3 uCamMatrix;","uniform vec2 uTextureSize;","uniform vec2 uResolution;","uniform float uT;","uniform float uPauseTime;","uniform vec2 uGravity;","uniform vec2 uPointSizeRange;","uniform vec3 uColEnv0;","uniform vec3 uColEnv1;","uniform vec3 uColEnv2;","uniform vec3 uColEnv3;","uniform vec2 uColEnvKeyframes;","uniform vec4 uAlphaGradient;","uniform vec2 uAlphaStops;","uniform float uAlpha;","uniform bool uLoop;","varying vec4 vCol;","varying mat4 vRotationMatrix;","varying vec4 vCell;","void main(void) {","float lerp;","float birthTime = aBirthLifespanAngle.x;","float lifespan = aBirthLifespanAngle.y;","float angularVelocity = aBirthLifespanAngle.z;","float deathTime = birthTime + lifespan;","float age = mod(uT-birthTime,lifespan);","float pauseTimeAge = mod(uPauseTime-birthTime,lifespan);","lerp =  age / lifespan;","gl_PointSize = mix(uPointSizeRange.x,uPointSizeRange.y,lerp);","float loopBirthTime = (uT - birthTime) / lifespan;","if (uT < birthTime || (uT >= deathTime && !uLoop ) || (uT >= uPauseTime - pauseTimeAge + lifespan)) {","gl_Position = vec4(9999.0,0,0,0);","} else {","vec2 pos = aXYVxVy.xy; ","vec2 vel = aXYVxVy.zw;","pos += age * vel;","pos += 0.5 * uGravity * age * age;","pos = (uCamMatrix * vec3(pos,1.0)).xy;","pos = (pos / uResolution) * 2.0 - 1.0;","gl_Position = vec4(pos * vec2(1, -1), 0, 1);","float colLerp = 1.0;","if (lerp <= uColEnvKeyframes.x) {","float cLerp = lerp / uColEnvKeyframes.x; ","vCol = vec4(mix(uColEnv0,uColEnv1,cLerp),1.0);","} else if (lerp > uColEnvKeyframes.x && lerp <= uColEnvKeyframes.y) {","float cLerp = (lerp - uColEnvKeyframes.x) / (uColEnvKeyframes.y - uColEnvKeyframes.x); ","vCol = vec4(mix(uColEnv1,uColEnv2,cLerp),1.0);","} else {","float cLerp = (lerp - uColEnvKeyframes.y) / (1.0 - uColEnvKeyframes.y); ","vCol = vec4(mix(uColEnv2,uColEnv3,cLerp),1.0);","}","if (lerp <= uAlphaStops.x) {","vCol.a = mix(uAlphaGradient.x,uAlphaGradient.y,lerp/uAlphaStops.x);","} else if (lerp >uAlphaStops.x && lerp <= uAlphaStops.y) {","vCol.a = mix(uAlphaGradient.y,uAlphaGradient.z,(lerp - uAlphaStops.x) / (uAlphaStops.y - uAlphaStops.x));","} else {","vCol.a = mix(uAlphaGradient.z,uAlphaGradient.w,(lerp - uAlphaStops.y) / (1.0 - uAlphaStops.y));","}","vCol.a *= uAlpha;","float ang = age * angularVelocity;","vec2 ratio = vec2(1.0 / uTextureSize.x,1.0 / uTextureSize.y);","vec4 normCell = aCellXYWH;","normCell.xz *= ratio;","normCell.yw *= ratio;","vec2 cellCenter = vec2(normCell.x + normCell.z / 2.0,normCell.y + normCell.w / 2.0);","float c = cos(ang);","float s = sin(ang);","mat4 transInMat = mat4(1.0, 0.0, 0.0, 0.0,","0.0, 1.0, 0.0, 0.0,","0.0, 0.0, 1.0, 0.0,","cellCenter.x,cellCenter.y, 0.0, 1.0);","mat4 rotMat = mat4(c, -s, 0.0, 0.0,","s, c, 0.0, 0.0,","0.0, 0.0, 1.0, 0.0,","0.0, 0.0, 0.0, 1.0);","mat4 resultMat = transInMat * rotMat;","resultMat[3][0] = resultMat[3][0] + resultMat[0][0] * -cellCenter.x + resultMat[1][0] * -cellCenter.y;","resultMat[3][1] = resultMat[3][1] + resultMat[0][1] * -cellCenter.x + resultMat[1][1] * -cellCenter.y;","resultMat[3][2] = resultMat[3][2] + resultMat[0][2] * -cellCenter.x + resultMat[1][2] * -cellCenter.y;","vRotationMatrix = resultMat;","vCell = normCell;","} ","}"];